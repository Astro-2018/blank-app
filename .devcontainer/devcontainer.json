import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import requests
from datetime import datetime

st.set_page_config(layout="wide")
st.title("ðŸ”¥ Heatseeker Lite")

st.sidebar.header("Settings")
api_key = st.sidebar.text_input("Polygon Key (optional for demo)", type="password")
ticker = st.sidebar.selectbox("Ticker", ["SPY", "QQQ", "AAPL", "TSLA"])
spot = st.sidebar.number_input("Spot Price", value=585.0)

# Demo data (always works)
strikes = np.arange(spot - 50, spot + 50, 2.5)
days = np.random.randint(7, 30, len(strikes))
oi = np.random.randint(5000, 25000, len(strikes))
df = pd.DataFrame({"strike": strikes, "oi": oi, "days": days})

# GEX calc
df["T"] = df["days"] / 365
df["gamma"] = 0.4 / (df["strike"] * 0.2 * np.sqrt(df["T"] + 0.001))
df["gex"] = -df["oi"] * df["gamma"] * spot ** 2 / 100

gex_df = df.groupby("strike")["gex"].sum().reset_index()
king = gex_df.loc[gex_df["gex"].idxmax(), "strike"]

# Chart
fig = go.Figure()
fig.add_trace(go.Bar(x=gex_df["strike"], y=gex_df["gex"]/1e6, marker_color="green"))
fig.add_vline(x=spot, line_dash="dot", line_color="blue")
fig.add_vline(x=king, line_dash="solid", line_color="yellow", annotation_text="King Node")
fig.update_layout(title=f"{ticker} GEX", xaxis_title="Strike", yaxis_title="GEX ($M)")
st.plotly_chart(fig)

st.metric("King Node", f"${king:.2f}")
st.dataframe(gex_df.round(2))
