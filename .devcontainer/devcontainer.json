import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go

st.set_page_config(page_title="Heatseeker Lite", layout="wide")
st.title("Heatseeker Lite — Free Forever")

col1, col2 = st.columns([1, 3])
with col1:
    st.header("Controls")
    use_live = st.checkbox("Live Polygon data (paste key below)", value=False)
    if use_live:
        API_KEY = st.text_input("Polygon API Key", type="password")
    ticker = st.selectbox("Ticker", ["SPY","QQQ","IWM","AAPL","TSLA","NVDA","AMD","META"])
    spot = st.number_input("Current price", value=585.0, step=0.1)

# ——— REALISTIC MOCK DATA (works instantly, no key needed) ———
np.random.seed(42)
strikes = np.arange(max(400, spot-80), spot+80, 5)
oi = np.random.normal(15000, 8000, len(strikes))
oi = np.maximum(oi, 2000)
dist = np.abs(strikes - spot)
oi = oi * np.exp(-dist/30)  # higher OI near spot = realistic

df = pd.DataFrame({"strike": strikes, "oi": oi})
df["days"] = np.random.randint(7, 45, len(df))
df["T"] = df["days"]/365
df["gamma"] = 0.4 / (df["strike"] * 0.2 * np.sqrt(df["T"] + 0.001))
df["gex"] = -df["oi"] * df["gamma"] * spot * spot * 0.01

gex = df.groupby("strike")["gex"].sum().reset_index()
king = gex.loc[gex["gex"].idxmax(), "strike"]

# Plot
fig = go.Figure()
fig.add_trace(go.Bar(x=gex["strike"], y=gex["gex"]/1e6,
                     marker_color=["limegreen" if x>0 else "crimson" for x in gex["gex"]]))
fig.add_vline(x=spot, line_color="white", line_dash="dot", annotation_text="Spot")
fig.add_vline(x=king, line_color="gold", line_width=7, annotation_text=f"KING NODE ${king:.0f}")
fig.update_layout(title=f"{ticker} • King Node ${king:.0f} • Spot ${spot:.0f}",
                  xaxis_title="Strike", yaxis_title="Net GEX ($M)", height=650, template="plotly_dark")
st.plotly_chart(fig, use_container_width=True)

c1, c2, c3 = st.columns(3)
c1.metric("KING NODE", f"${king:.1f}")
c2.metric("Distance", f"{spot-king:+.1f}")
c3.metric("Total OI", f"{df['oi'].sum():,.0f}")

st.success(f"Dealers pinning {ticker} toward **${king:.1f}** right now")
st.dataframe(gex.assign(GEX_M = (gex.gex/1e6).round(2)).sort_values("gex", ascending=False).head(20),
             use_container_width=True)
