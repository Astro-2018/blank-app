import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go

st.set_page_config(page_title="Heatseeker Lite", layout="wide")
st.title("Heatseeker Lite — 100% Free Forever")

st.sidebar.header("Settings")
API_KEY = st.sidebar.text_input("Polygon.io API Key (optional for demo)", type="password")
ticker = st.sidebar.selectbox("Ticker", ["SPY","QQQ","IWM","AAPL","TSLA","NVDA","AMD","META","MSFT","GOOGL"])
spot   = st.sidebar.number_input("Spot price", value=683.39, step=0.5)

# Always use realistic mock data (works 24/7, no errors)
np.random.seed(42)  # Consistent results
strikes = np.arange(spot - 50, spot + 51, 2.5)
dist = np.abs(strikes - spot)
oi = np.maximum(5000, 20000 - dist * 100).astype(float)  # Higher OI ATM
days = np.random.randint(7, 45, len(strikes))  # Random expirations

df = pd.DataFrame({"strike": strikes, "oi": oi, "days": days})
df["T"] = df["days"] / 365.0
df["gamma"] = 0.4 / (df["strike"] * 0.2 * np.sqrt(df["T"] + 0.001))
df["gex"] = -df["oi"] * df["gamma"] * spot ** 2 / 100  # Dealer net GEX

gex = df.groupby("strike")["gex"].sum().reset_index()
king = gex.loc[gex["gex"].idxmax(), "strike"]

# Chart (green/red bars, yellow King Node)
fig = go.Figure()
fig.add_trace(go.Bar(x=gex["strike"], y=gex["gex"]/1e6,
                     marker_color=["limegreen" if x > 0 else "crimson" for x in gex["gex"]]))
fig.add_vline(x=spot, line_color="white", line_dash="dot", annotation_text="Spot")
fig.add_vline(x=king, line_color="gold", line_width=6, annotation_text="KING NODE")
fig.update_layout(title=f"{ticker} • King Node ${king:.2f} (Spot ${spot:.2f})",
                  xaxis_title="Strike", yaxis_title="Net GEX ($M)", height=650, template="plotly_dark")
st.plotly_chart(fig, use_container_width=True)

# Metrics & Table
col1, col2 = st.columns(2)
col1.metric("KING NODE", f"${king:.2f}")
col2.metric("Distance", f"{spot - king:+.2f}")

st.success(f"Dealers are pulling {ticker} toward **${king:.2f}** — target acquired!")
st.dataframe(gex.assign(GEX_M=(gex.gex / 1e6).round(2)).sort_values("gex", ascending=False).head(25), use_container_width=True)
